# Cache映射方式总结

- Cache简介
  - Cache运算速度比主存快，在计算机设计中需要将数据和指令通过cache传送到CPU进行处理。在处理数据的时候总是首先查看待处理的数据的位置，如果在Cache中就直接传送到CPU处理，否则查找主存中数据的位置，将其传送到Cache中再传送到CPU中处理。
  - Cache有$r$行，每行分为$s-r$位的标记和$K$个字
  - 主存有$2^n$个字，每$K$个字组成一块，于是主存中有$M=\frac{2^n}{K}$个块。且$M>>r$。由于主存块数较Cache行数远大，需要使用映射。
- 明确概念
  - 主存地址:
    - 共有$s+w$位，唯一地标识了一个字
  - Cache存储结构
    - 在直接映射中，Cache的一行由一个$s-r$位的标记$+K(K=2^w)$个字的地址构成。Cache的一行与主存中一块的储存量相同，都是$K$个字。
  
- **映射方式**
  - 直接映射
  - 全相联映射
  - 组相联映射

- 直接映射
  - 将主存地址分成$3$部分
    - 低$w$位唯一表示某一个字。一个块内共有$2^w$个字。
    - 高$s$位标识索引位置$j$，其中
      - 低$r$位标识块内相对位置，也即从主存定位Cache的索引号。利用$j\equiv i(mod m)$，而$m=2^r$的特点，$j$的低$r$位恰好是$i$，也即对某一给定块而言，值为$i$的$r$位标识了其在块内的相对位置。
        > $m=2^r$是为了电路实现方便和逻辑运算简便而人为设定的
      - 高$s-r$位表征块号。这是考虑到从cache中定位到主存内，需要块号进行索引。
  - 例
    - Cache行/主存块长为$4$字 $\Rightarrow K=2^w=4\Rightarrow w=2$
    - Cache共$16$行$\Rightarrow2^r=16\Rightarrow r=4$
    - 主存共$64$块($256$字)$\Rightarrow 2^s=64\Rightarrow s=6.$
  
    $\Rightarrow$主存中一条信息有$8$位，前$2$位标识块号($00,01,10,11$),中间$4$位标识块内相对位置，最后两位标识块内的字。
  - 查询操作：（已知要读取的主存的字的位置）
    -  检查该主存地址对应的cache位置是否已经存放了该元素。如果是则称cache命中。
       -  比较方法：根据块内相对位置找到该字对应的cache位置，比较块号(前$s-r$位)
  
- 全相联映射
  - 随机地将主存地址映射到Cache中，在Cache行中用一个$s$位的tag标识主存地址。
  - 查找cache是否命中时，将主存地址的前$s$位与所有的Cache tag进行比较。
  
- 组相联映射
  - 一种折中方法。将Cache分成一些组号，分配组时采用直接映射，在组内采用全相联映射。
  - 映射表示成
  $$
  m=v*k, i\equiv j(mod v)
  $$
    - notations:
      - $m$: Cache行数
      - $v$: Cache组数
        > $v=2^t$
      - $k$: Cache一组的行数
      - $i$: Cache组号
      - $j$: 主存块号
  - 主存地址共$s+w$位，后$w$位为字号，前$s$位为块号。在组关联映射中，前$s$位的后$t$位为组号，直接映射。前$s-t$位为tag。随机写入cache组内时，记在cache的tag上。
  - $k$路组关联映射
  - 例子
    - 主存地址$10001001$,最后两位$01$为字号，第$5-6$位$10$为组号(直接映射)，前$4$位$1001$为组内编号(全相联映射)，是组里的tag.
    - 要查询时首先在主存地址里找到组号$d$位对应的cache部分，然后挨个比较主存地址的$s-d$位与tag是否相同。